

library('vegan')
library('RColorBrewer')

#display.brewer.all()


data_matrix <- read.table('Data_trial_data.txt', sep='\t', comment='', head=T, row.names=1)
data_meta   <- read.table('Meta_trial_data.txt', sep='\t', comment='', head=T, row.names=1)

data_matrix_t <- t(data_matrix)

# Calculate three different kinds of distances, for users to choose from
 # Euclidean distance
 #d.euc <- dist(data_matrix_t)
 # Bray-Curtis distance
 d.bray <- vegan::vegdist(data_matrix_t)
 show.d.bray <- as.matrix(d.bray)
 write.table(show.d.bray, file = "bray_curtis_result.txt", sep = "\t")
 # Chi-square distance
 #my.ca <- cca(data_matrix_t)
 #d.chisq <- as.matrix(dist(my.ca$CA$u[,1:2]))

# Run principal coordinates embedding on the distance metrics
 # Run PCoA (not PCA);
 #pc.euc <- cmdscale(d.euc, k=2)
 # Bray-Curtis principal coords
 pc.bray <- cmdscale(d.bray, k=3, eig = TRUE)
 
 lambda <- as.numeric(pc.bray$eig)
 contribution_1 <- 3.973/sum(lambda)
 contribution_2 <- 2.857/sum(lambda)
 
 # get first two dimensions of chi-square coordinates:
 #pc.chisq <- my.ca$CA$u[,1:2]

# Set colors to different samples according to the grouping information
 # groups_individual <- data_meta[,2]
 # duplicated_groups_individual <- which(duplicated(groups_individual))
 # group_individual_labels <- groups_individual[-duplicated_groups_individual]
 # 
 # groups_medium <- data_meta[,3]
 # duplicated_groups_medium <- which(duplicated(groups_medium))
 # group_medium_labels <- groups_medium[-duplicated_groups_medium]
 
 groups_time <- data_meta[,4]
 duplicated_groups_time <- which(duplicated(groups_time))
 group_time_labels <- groups_time[-duplicated_groups_time]
 my.pch <- c(21,22,23,24,25)
 pch_mode = my.pch[groups_time]
   
 groups <- data_meta[,1]
 my.colors.fill <- c('red','orange','yellow','blue3','deepskyblue1','cyan','green3','green','greenyellow')
 my.colors.line <- c('red3','darkorange','gold','midnightblue','blue3','cyan4','darkgreen','green3','green2')
 color_mode_fill = my.colors.fill[groups]
 color_mode_line = my.colors.line[groups]
 
  
# Plot PCoA according to user-selected distance calculation method
 par(mar=c(5.1, 4.1, 4.1, 8.1), xpd=TRUE)
 plot(pc.bray[,1], pc.bray[,2],  pch = 21, bg = color_mode_fill, col = color_mode_line, cex = 2,xlab = "PCoA1", ylab = "PCoA2")

# Add legend to figure
 
 duplicated_groups <- which(duplicated(groups))
 group_labels <- groups[-duplicated_groups]

 
 legend("topright", inset=c(-0.3,0.1),legend = group_labels, cex = 1.0, col = my.colors.fill[group_labels], pch = 15)
 legend("bottomright", inset=c(-0.18,0),legend = group_time_labels, cex = 1.2,  pch = my.pch[group_time_labels], col = 'black')
 

 