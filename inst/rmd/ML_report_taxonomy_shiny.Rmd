---
title: "MetaLab_taxonomy.xslx Quick View"
author: Suggestions to "imetalabca@gmail.com"
date: "`r Sys.time()`"
output:
  html_document:
    fig_width: 10
    fig_caption: TRUE
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: TRUE
      smooth_scroll: TRUE
    number_sections: true
runtime: shiny
params:  
  input_datatable: !r mtcars ### note that the value is the real value, here supposed to be a read in data.table for one click function.  
---

<style type="text/css">
.main-container {
  max-width: 1400px;
  margin-left: auto;
  margin-right: auto;
}
</style>


```{r setup, include=FALSE}
# enviroment setup
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE, cache = TRUE)

library(tidyverse)
library(ggplot2)
library(plotly)
library(readxl)
library(shiny)
library(pheatmap)
library(reshape2)
library(vegan)
library(ggdendro)

#library(plotly)
# library(DT)
# for interactive data table display 

# local usage test and debug
# rmarkdown::render("MQ_report_taxonomy_ocpu.Rmd", params = list(summary_file_tbl =  your_readin_tbl))
# on local machine, your_readin_tbl is a data table, while on ocpu, your_readin_tbl is a json formatted table

# version control
# 20190819



```



```{r function_needed, recho=FALSE}

tidy_MQ_taxonomy <- function(df_taxonomy.txt){
  
    extract_species_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Species', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    extract_genus_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Genus', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    extract_family_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Family', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    extract_order_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Order', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    extract_class_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Class', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    extract_phylum_gg <- melt(data = df_taxonomy.txt[df_taxonomy.txt$Rank == 'Phylum', -c(2:10)],               
                            id.vars = c("Name"), variable.name = "Sample", value.name = "Intensity")
    
    extract_species <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Species', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")
    extract_genus <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Genus', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")
    extract_family <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Family', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")
    extract_order <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Order', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")
    extract_class <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Class', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")
    extract_phylum <- df_taxonomy.txt[df_taxonomy.txt$Rank == 'Phylum', -c(2:10)]  %>%  remove_rownames %>% column_to_rownames(var="Name")

    return(list("extract_species_gg" = extract_species_gg,
                "extract_genus_gg" = extract_genus_gg,
                "extract_family_gg" = extract_family_gg,
                "extract_order_gg" = extract_order_gg,
                "extract_class_gg" = extract_class_gg,
                "extract_phylum_gg" = extract_phylum_gg,
                "extract_species" = extract_species,
                "extract_genus" = extract_genus,
                "extract_family" = extract_family,
                "extract_order" = extract_order,
                "extract_class" = extract_class,
                "extract_phylum" = extract_phylum
    ))

}

```



```{r file_taxonomy, echo=FALSE, fig.width= 15,fig.height=10}
# start from the parameterized version

df_taxonomy.txt <-params$input_datatable

# start from the data table
#df_taxonomy.txt  <- read_excel("MetaLab_taxonomy.xlsx", sheet = 2)

summary_file_taxonomy <- tidy_MQ_taxonomy(df_taxonomy.txt)


```

# Intro

**This report provides some basic description and visualization of the MetaLab taxonomy results. **
**The report is based on the MetaLab_taxonomy.xlsx, without defined experimental design/grouping information.**
**Users can use this to quickly check the taxonomic profile of the dataset at each taxonomic level.**


# Sample overview

*  **Number of samples in your dataset: ** `r ncol(df_taxonomy.txt)-10`
*  **Number of species identified: ** `r nrow(summary_file_taxonomy$extract_species)`
*  **Number of genera identified: ** `r nrow(summary_file_taxonomy$extract_genus)`
*  **Number of families identified: ** `r nrow(summary_file_taxonomy$extract_family)`
*  **Number of orders identified: ** `r nrow(summary_file_taxonomy$extract_order)`
*  **Number of classes identified: ** `r nrow(summary_file_taxonomy$extract_class)`
*  **Number of phyla identified: ** `r nrow(summary_file_taxonomy$extract_phylum)`

# Identification per sample
```{r identification_in, echo=FALSE}

selectInput("level1", "Select taxonomic level:", c("Species", "Genus", "Family", "Order", "Class", "Phylum"), selected = "Species")

```

```{r identification_fig, echo=FALSE,fig.width= 12,fig.height=8, cache = FALSE}

renderPlotly({
  if(input$level1 == "Species"){
    my_data = summary_file_taxonomy$extract_species
  } else if(input$level1 == "Genus"){
    my_data = summary_file_taxonomy$extract_genus
  } else if(input$level1 == "Family"){
    my_data = summary_file_taxonomy$extract_family
  } else if(input$level1 == "Order"){
    my_data = summary_file_taxonomy$extract_order
  } else if(input$level1 == "Class"){
    my_data = summary_file_taxonomy$extract_class
  } else {
    my_data = summary_file_taxonomy$extract_phylum
  }
  
  idnumber <- specnumber(t(my_data))
  idnumber <- as.data.frame(idnumber)
  idnumber <- as.data.frame(cbind(names = rownames(idnumber), idnumber))
    
  ggplotly(ggplot(data=idnumber) +
      geom_col(aes(x=names, y=idnumber)) + theme_bw() +coord_flip()+ 
      xlab("Sample labels") + ylab("Numbers identified")
  )
    
})


```


# Alpha diversity

The figure below displays the alpha-diversity on the species level.
```{r alpha_in, echo=FALSE}

selectInput("index", "Select diversity index:", c("Shannon-Wiener index" = "shannon", "Simpson's index" = "simpson", "InvSimpson index" = "invsimpson"), selected = "shannon")

```

```{r alpha_fig, echo=FALSE,fig.width= 6,fig.height=4, cache = FALSE}
renderPlotly({
    diversity <- round(diversity(t(summary_file_taxonomy$extract_species),index = input$index),3)
    Alpha_diversity <- as.data.frame(diversity)
    Alpha_diversity <- as.data.frame(cbind(names = rownames(Alpha_diversity), Alpha_diversity))
    
    ggplotly(ggplot(data=Alpha_diversity) +
      geom_col(aes(x=names, y=diversity)) + theme_bw() +coord_flip()+ 
      xlab("Sample labels") + ylab("Alpha-diversity")
    )

})

```

# Beta diversity
The figure below displays the beta-diversity on the species level, visualized using PCoA.
```{r beta, echo=FALSE,fig.width= 8,fig.height=8}

data_matrix_t <- t(summary_file_taxonomy$extract_species)
d.bray <- vegan::vegdist(data_matrix_t)
show.d.bray <- as.matrix(d.bray)
pc.bray <- cmdscale(d.bray, k=3, eig = TRUE)

beta_diversity <- as.data.frame(pc.bray$points)
beta_diversity <- as.data.frame(cbind(names = rownames(beta_diversity), beta_diversity))

plot_ly(beta_diversity, x = ~V1, y = ~V2, z = ~V3, color = ~names, colors = c("red","orange","yellow","green","cyan","blue","purple","black","gray50","gray80")) %>% 
  add_markers() %>%  
  add_text(text = ~names) %>%
  hide_legend()


```

# Sample Clustering
```{r cluster_in, echo=FALSE}

selectInput("level3", "Select taxonomic level:", c("Species", "Genus", "Family", "Order", "Class", "Phylum"), selected = "Species")

selectInput("dist_method", "Select distance measure to be used:", c("euclidean", "maximum", "manhattan", "canberra", "binary", "minkowski"), selected = "euclidean")

selectInput("aggl_method", "Select agglomeration method to be used:", c("ward.D", "ward.D2", "single", "complete", "average", "mcquitty", "median", "centroid"), selected = "ward.D")
```

```{r cluster_fig, echo=FALSE,fig.width= 8, fig.height=6, cache = FALSE}
renderPlot({
  if(input$level3 == "Species"){
    my_data = summary_file_taxonomy$extract_species
  } else if(input$level3 == "Genus"){
    my_data = summary_file_taxonomy$extract_genus
  } else if(input$level3 == "Family"){
    my_data = summary_file_taxonomy$extract_family
  } else if(input$level3 == "Order"){
    my_data = summary_file_taxonomy$extract_order
  } else if(input$level3 == "Class"){
    my_data = summary_file_taxonomy$extract_class
  } else {
    my_data = summary_file_taxonomy$extract_phylum
  }
  
  distance <- dist(t(my_data), method = input$dist_method)
  fit <- hclust(distance, method= input$aggl_method)
  ggdendrogram(fit, rotate = TRUE, theme_dendro = FALSE, size = 2) + xlab("Samples") + ylab("Distance") +
               theme_bw()
  
})

```


# Taxonomic composition bar plots

```{r composition_in, echo=FALSE}

selectInput("level2", "Select taxonomic level:", c("Species", "Genus", "Family", "Order", "Class", "Phylum"), selected = "Species")

```

Combosition bar plot:
```{r composition_fig, echo=FALSE,fig.width= 12,fig.height=8, cache = FALSE}

renderPlotly({
  if(input$level2 == "Species"){
    my_data = summary_file_taxonomy$extract_species_gg
  } else if(input$level2 == "Genus"){
    my_data = summary_file_taxonomy$extract_genus_gg
  } else if(input$level2 == "Family"){
    my_data = summary_file_taxonomy$extract_family_gg
  } else if(input$level2 == "Order"){
    my_data = summary_file_taxonomy$extract_order_gg
  } else if(input$level2 == "Class"){
    my_data = summary_file_taxonomy$extract_class_gg
  } else {
    my_data = summary_file_taxonomy$extract_phylum_gg
  }
  ggplotly(ggplot(my_data, aes(x = Sample, y = Intensity, fill = Name)) +
             geom_bar(stat='identity') + theme_bw() +
             ylab("Intensity") + theme(axis.text.x = element_text(angle = 45, hjust = 1))
  )
})


```

